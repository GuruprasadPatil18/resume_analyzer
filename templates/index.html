<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GP's AI Resume Analyzer</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind & Plugins -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com/3.4.1?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5; /* Indigo-600 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Navbar -->
    <nav class="glass-effect fixed top-0 w-full z-40 border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-robot text-xl"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight text-slate-900">GP's AI Resume Analyzer</span>
                </div>
                
                {% if analysis_result_html %}
                <button onclick="downloadPDF()" class="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center gap-2 shadow-md">
                    <i class="fa-solid fa-file-arrow-down"></i> Download Report
                </button>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">
        
        <!-- Input Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 mb-10 transition-all hover:shadow-xl">
            <form id="analysisForm" action="/analyze" method="POST" enctype="multipart/form-data" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <!-- Upload Column -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">1. Upload Resume (PDF/DOCX)</label>
                        <div class="relative border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-indigo-500 hover:bg-indigo-50 transition-colors cursor-pointer group">
                            <input type="file" id="resumeFile" name="resume_file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" required>
                            <div class="space-y-2">
                                <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 group-hover:text-indigo-500 transition"></i>
                                <p class="text-sm text-slate-500 group-hover:text-indigo-600 font-medium">Click or drag file here</p>
                                <p id="fileNameDisplay" class="text-xs text-slate-400 mt-2"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Job Desc Column -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-700">2. Job Description</label>
                        <textarea id="jobDescription" name="job_description" rows="5" class="w-full p-4 rounded-xl border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all text-sm resize-none shadow-sm" placeholder="Paste the full job description here..." required>{{ job_description or '' }}</textarea>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button type="submit" id="analyzeButton" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all transform hover:-translate-y-0.5 active:translate-y-0 flex items-center gap-2">
                        <span>Analyze Resume</span>
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </button>
                </div>
            </form>
        </div>

        <!-- Results Area -->
        {% if analysis_result_html %}
        <div id="analysisResultsContainer" class="animate-fade-in-up">
            
            <!-- Dashboard Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                
                <!-- Score Card -->
                <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden">
                    <h3 class="text-lg font-bold text-slate-700 mb-4 absolute top-6 left-6">Match Score</h3>
                    <div class="relative w-40 h-40 mt-6">
                        <canvas id="scoreChart"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-4xl font-extrabold text-slate-800">{{ match_score }}%</span>
                        </div>
                    </div>
                </div>

                <!-- Keywords Card -->
                <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-md border border-slate-100 flex flex-col">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">Keyword Analysis</h3>
                    <div class="flex-1 overflow-y-auto">
                        {% if missing_keywords %}
                            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg mb-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fa-solid fa-triangle-exclamation text-red-600"></i>
                                    <span class="font-semibold text-red-800">Missing Critical Skills</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    {% for word in missing_keywords %}
                                        <span class="bg-white text-red-600 px-3 py-1 rounded-full text-xs font-bold border border-red-100 shadow-sm">{{ word }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-r-lg h-full flex flex-col items-center justify-center text-center">
                                <i class="fa-solid fa-circle-check text-4xl text-green-500 mb-3"></i>
                                <h4 class="text-lg font-bold text-green-800">Perfect Match!</h4>
                                <p class="text-green-700 text-sm">Your resume hits every key requirement found in the job description.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Detailed Report & Tools -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                
                <!-- Left Column: Report & Actions (7 cols) -->
                <div class="lg:col-span-7 space-y-8">
                    
                    <!-- AI Report -->
                    <div class="bg-white p-8 rounded-2xl shadow-md border border-slate-100">
                        <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                            <div class="bg-indigo-100 text-indigo-600 p-2 rounded-lg">
                                <i class="fa-solid fa-file-lines"></i>
                            </div>
                            <h2 class="text-xl font-bold text-slate-800">Detailed Analysis</h2>
                        </div>
                        <div class="prose prose-slate prose-sm max-w-none prose-headings:text-slate-800 prose-p:text-slate-600">
                            {{ analysis_result_html | safe }}
                        </div>
                    </div>

                    <!-- Bonus Tools (Ignored by PDF) -->
                    <div class="bg-white p-8 rounded-2xl shadow-md border border-slate-100" data-html2pdf-ignore="true">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-purple-100 text-purple-600 p-2 rounded-lg">
                                <i class="fa-solid fa-toolbox"></i>
                            </div>
                            <h2 class="text-xl font-bold text-slate-800">Smart Tools</h2>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <button onclick="generateContent('/generate_questions', 'Interview Prep Questions')" class="group bg-gradient-to-br from-indigo-50 to-white border border-indigo-100 p-4 rounded-xl hover:shadow-md transition-all text-left flex flex-col gap-2">
                                <div class="flex items-center justify-between w-full">
                                    <span class="font-bold text-indigo-900 group-hover:text-indigo-600">Interview Prep</span>
                                    <i class="fa-solid fa-users-viewfinder text-indigo-300 group-hover:text-indigo-500 transition"></i>
                                </div>
                                <span class="text-xs text-slate-500">Generate 5 tech & 3 behavioral questions.</span>
                            </button>
                            
                            <button onclick="generateContent('/generate_cover_letter', 'Professional Cover Letter')" class="group bg-gradient-to-br from-emerald-50 to-white border border-emerald-100 p-4 rounded-xl hover:shadow-md transition-all text-left flex flex-col gap-2">
                                <div class="flex items-center justify-between w-full">
                                    <span class="font-bold text-emerald-900 group-hover:text-emerald-600">Cover Letter</span>
                                    <i class="fa-solid fa-pen-nib text-emerald-300 group-hover:text-emerald-500 transition"></i>
                                </div>
                                <span class="text-xs text-slate-500">Draft a tailored cover letter instantly.</span>
                            </button>
                        </div>

                        <!-- Bullet Refiner -->
                        <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                <i class="fa-solid fa-wand-magic-sparkles text-amber-500 mr-1"></i> Bullet Point Refiner
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="bulletInput" placeholder="Paste a weak bullet point here (e.g. 'Worked on sales')..." class="flex-1 p-3 text-sm rounded-lg border border-slate-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
                                <button onclick="rewriteBullet()" class="bg-slate-800 text-white px-5 py-2 rounded-lg text-sm font-medium hover:bg-slate-700 transition">Rewrite</button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right Column: Resume Preview (5 cols) -->
                <div class="lg:col-span-5">
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-100 sticky top-24 h-[calc(100vh-8rem)] flex flex-col">
                        <div class="flex items-center gap-2 mb-4 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-highlighter text-indigo-500"></i>
                            <h2 class="text-lg font-bold text-slate-800">Keyword Highlighter</h2>
                        </div>
                        <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar bg-slate-50 p-4 rounded-lg border border-slate-200 font-mono text-xs leading-relaxed text-slate-700 whitespace-pre-wrap">
                            {{ highlighted_text | safe }}
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- Hidden Data Storage -->
        <div id="hiddenResumeText" style="display:none;">{{ resume_text }}</div>
        <div id="matchScoreData" style="display:none;">{{ match_score }}</div>
        {% endif %}

    </main>

    <!-- Loading Overlay -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col justify-center items-center">
        <div class="spinner w-16 h-16 mb-4"></div>
        <p class="text-xl font-bold text-slate-700 animate-pulse">Analyzing your profile...</p>
        <p class="text-sm text-slate-500 mt-2">This usually takes about 5-10 seconds</p>
    </div>

    <!-- Modal -->
    <div id="resultModal" class="hidden fixed inset-0 z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border border-slate-200">
                    
                    <!-- Modal Header -->
                    <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-slate-800" id="modalTitle">Result</h3>
                        <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition bg-white p-1 rounded-full hover:bg-slate-200 w-8 h-8 flex items-center justify-center">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    
                    <!-- Modal Body -->
                    <div class="px-8 py-8 max-h-[60vh] overflow-y-auto prose prose-indigo max-w-none bg-white" id="modalContent">
                        <!-- Content injects here -->
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex flex-row-reverse gap-3">
                        <button onclick="copyToClipboard()" class="inline-flex justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 gap-2 items-center">
                            <i class="fa-regular fa-copy"></i> Copy Text
                        </button>
                        <button onclick="closeModal()" class="inline-flex justify-center rounded-lg bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- File Input Display ---
        document.getElementById('resumeFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            if (fileName) document.getElementById('fileNameDisplay').textContent = fileName;
        });

        // --- Chart Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const scoreElement = document.getElementById('matchScoreData');
            if (scoreElement) {
                const score = parseInt(scoreElement.innerText) || 0;
                const ctx = document.getElementById('scoreChart').getContext('2d');
                
                let color = '#ef4444'; // Red
                if(score >= 50) color = '#eab308'; // Yellow
                if(score >= 75) color = '#22c55e'; // Green

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Match', 'Missing'],
                        datasets: [{
                            data: [score, 100 - score],
                            backgroundColor: [color, '#f1f5f9'],
                            borderWidth: 0,
                            cutout: '85%',
                            borderRadius: 20
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        animation: { animateScale: true, animateRotate: true }
                    }
                });
            }
        });

        // --- PDF Logic ---
        function downloadPDF() {
            const element = document.getElementById('analysisResultsContainer');
            const opt = {
                margin: [0.5, 0.5],
                filename: 'GP_Resume_Analysis.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // --- Modal & Tools Logic ---
        async function generateContent(endpoint, title, extraData = {}) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const resumeText = document.getElementById('hiddenResumeText')?.innerText;
            const jd = document.getElementById('jobDescription').value;

            if (!resumeText) return alert("Please analyze a resume first!");

            modalTitle.innerText = title;
            modalContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12">
                    <div class="spinner w-12 h-12 mb-4"></div>
                    <p class="text-slate-500 font-medium">Generating AI content...</p>
                </div>
            `;
            document.getElementById('resultModal').classList.remove('hidden');

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resume_text: resumeText, job_description: jd, ...extraData })
                });
                const data = await response.json();
                if (data.html) modalContent.innerHTML = data.html;
                else modalContent.innerHTML = `<p class="text-red-500 bg-red-50 p-4 rounded">Error: ${data.error}</p>`;
            } catch (err) {
                modalContent.innerHTML = '<p class="text-red-500">Connection error.</p>';
            }
        }

        async function rewriteBullet() {
            const text = document.getElementById('bulletInput').value;
            if (!text) return alert("Please enter a bullet point first.");
            generateContent('/rewrite_bullet', 'Optimized Bullet Points', { bullet_text: text });
        }

        function closeModal() { document.getElementById('resultModal').classList.add('hidden'); }
        
        function copyToClipboard() {
            const content = document.getElementById('modalContent').innerText;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.querySelector('#resultModal button i.fa-copy').parentElement;
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = original, 2000);
            });
        }

        document.getElementById('analysisForm').addEventListener('submit', function() {
            if (document.getElementById('resumeFile').value) {
                document.getElementById('loadingSpinner').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>